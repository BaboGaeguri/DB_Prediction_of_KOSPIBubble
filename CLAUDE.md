# 3.2 실험 설계 및 프레임워크 구성

본 연구는 PSY 절차를 통해 정의된 코스피 버블 상태를 머신러닝 분류모형으로 식별하는 프레임워크를 구축한다. 전체 분석 절차는 다음 네 단계로 구성된다.

1. 버블 라벨 생성
2. 분류용 데이터셋 구성
3. 학습·검증 전략 설정
4. 기준모형과의 성능 비교

---

## 3.2.1 버블 라벨 생성

Phillips, Shi, and Yu(2015)의 PSY 절차를 적용하여 코스피 지수의 버블 형성 및 붕괴 시점을 식별한다. PSY 검정 결과에 따라 각 시점 $t$에 대해 버블 상태 여부를 이진 변수로 정의한 뒤, 버블 구간 내에서 방향성을 추가로 분류하는 다중라벨(multilabel) 구조를 적용한다.

### 이진 분류 (bubble)

- 버블 구간: $bubble_t = 1$
- 비버블 구간: $bubble_t = 0$

### 다중라벨 분류 (bubble_up / bubble_down)

Atsiwo(2025)의 방법론을 참고하여, 버블로 식별된 구간($bubble_t = 1$)을 자산가격 상승기(bubble up)와 붕괴기(bubble down)로 세분화한다.

$$\text{bubble\_up}_t = \begin{cases} 1, & \text{if } bubble_t = 1 \text{ and } \frac{Y_{t+1} + \cdots + Y_{t+\tau}}{\tau} > Y_t \\ 0, & \text{otherwise} \end{cases}$$

$$\text{bubble\_down}_t = \begin{cases} 1, & \text{if } bubble_t = 1 \text{ and } \frac{Y_{t+1} + \cdots + Y_{t+\tau}}{\tau} \leq Y_t \\ 0, & \text{otherwise} \end{cases}$$

여기서 $\tau$는 향후 관측 윈도우 크기(기본값: 3개월), $Y_t$는 시점 $t$의 P/D ratio이다. 한 시점이 bubble이면서 동시에 bubble_up 또는 bubble_down 중 하나로 분류되므로 multilabel 구조에 해당한다.

### 구현 세부사항

버블 라벨은 BSADF 시계열과 Monte Carlo 시뮬레이션 임계값을 비교하여 생성한다.

1. 각 시점 $t$에서 BSADF 통계량을 계산
2. Monte Carlo 시뮬레이션으로 임계값(95% CV) 산출
3. $BSADF_t > CV_{95}$ 이면 $bubble_t = 1$, 아니면 $bubble_t = 0$
4. $bubble_t = 1$인 시점에서 향후 $\tau$개월 평균 P/D ratio와 현재값을 비교하여 bubble_up / bubble_down 분류
5. 생성된 라벨(bubble, bubble_up, bubble_down)을 CSV로 저장하여 이후 분류 모델의 입력으로 사용

### 성능 최적화

Monte Carlo 시뮬레이션은 계산 비용이 크므로 다음 두 가지 최적화를 적용한다.

- **NumPy 직접 OLS**: `statsmodels.OLS` 대신 $\hat{\beta} = (X^\top X)^{-1} X^\top y$ 공식을 NumPy로 직접 계산하여 객체 생성 오버헤드를 제거 (약 5~10배 속도 향상)
- **멀티프로세싱 병렬화**: Monte Carlo 시뮬레이션 $n_{sim}$회는 각 시뮬레이션이 독립적이므로 `multiprocessing.Pool`로 CPU 코어 수에 비례하여 병렬 실행 (Windows 환경에서 `if __name__ == '__main__':` 가드 필수)

---

## 3.2.2 분류용 데이터셋 구성

설명변수 행렬 $X_t$는 시점 $t$까지 관측 가능한 거시·금융 변수들로 구성한다. 모든 설명변수는 시점 정렬을 엄격히 유지하며, 타깃 변수 $y_t$와 동일한 시점을 기준으로 정렬한다.

최종 데이터셋 구조:

$$(X_t, y_t)$$

이는 **"시점 $t$의 정보로 시점 $t$의 버블 상태를 식별하는"** 분류 문제로 정의된다.

---

## 3.2.3 학습 및 검증 전략

시계열 데이터의 특성을 고려하여 무작위 분할 대신 **시간 순서를 유지한 분할 방식**을 적용한다. 전체 표본을 시간 순서에 따라 학습 구간과 평가 구간으로 구분하며, 학습 구간에서 모형을 학습한 뒤 이후 구간의 버블 상태를 예측한다.

이를 통해 특정 구간에 과적합된 결과가 아닌지 점검하고, 모형의 일반화 성능을 평가한다.

---

## 3.2.4 예측 모형 및 비교 모형

| 모형 | 설명 |
|------|------|
| **XGBoost** (주요 모형) | 비선형 관계 및 변수 간 상호작용을 학습하는 그래디언트 부스팅 기반 앙상블 모형 |
| 단순 기준모형 | 항상 비버블(0)을 예측 |
| 로지스틱 회귀 | 전통적 통계모형 비교용 |

이를 통해 XGBoost가 전통적 통계모형 대비 분류 성능 개선을 보이는지 검증한다.

---

## 3.2.5 평가 지표

버블 구간은 전체 기간 중 일부에만 나타나는 사건일 가능성이 높으므로, 단순 정확도 대신 불균형 분류에 적합한 지표를 활용한다.

| 지표 | 용도 |
|------|------|
| **PR-AUC** | 불균형 데이터에서의 정밀도-재현율 성능 |
| **F1-macro** | 클래스 균형 고려한 F1 점수 |
| **Balanced Accuracy** | 클래스별 정확도의 평균 |

모형의 성능은 평가 구간(out-of-sample)에서 산출된 **분류 결과**를 기준으로 비교하며, 이를 통해 가설 1(H1)을 검정한다.
